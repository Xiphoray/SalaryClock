<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SalaryClock</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
:root{--bg-day:#f7f7f7;--fg-day:#222;--bg-night:#0b0c10;--fg-night:#e6e6e6;--accent:#0d6efd;--wheel-speed:300ms;--mc-digit-fs:clamp(28px,12vw,56px);--mc-digit-width:calc(var(--mc-digit-fs)*1.14);--mc-digit-height:calc(var(--mc-digit-fs)*1.57);--mc-gap:clamp(3px,1.8vw,8px)}

html,body,#moneyclock-app{height:100%}
body{font-family:"Segoe UI","SegoeUI","Microsoft Yahei UI","Helvetica Neue",Arial,sans-serif;font-weight:700;background:#f7f7f7;color:#222}
@media (prefers-color-scheme: dark){body{background:var(--bg-night);color:var(--fg-night)}}
#moneyclock-app{display:flex;align-items:center;justify-content:center;text-align:center;min-height:100vh}
#moneyclock-app .moneyclock-container{padding-left:clamp(12px,4vw,20px);padding-right:clamp(12px,4vw,20px)}

.moneyclock-container{width:100%;max-width:960px;margin:0 auto;box-sizing:border-box}
.moneyclock-wage{display:inline-flex;align-items:center;justify-content:center;gap:var(--mc-gap);line-height:1;margin:0 auto;max-width:100%;overflow:hidden;transform-origin:center center;will-change:transform}
.moneyclock-wage>*{margin-right:var(--mc-gap)}
.moneyclock-wage>*:last-child{margin-right:0}
.moneyclock-digit{position:relative;width:var(--mc-digit-width);height:var(--mc-digit-height);overflow:hidden;border-radius:10px;background:rgba(0,0,0,0.04);box-shadow:inset 0 1px 2px rgba(0,0,0,0.08)}
@media (prefers-color-scheme: dark){.moneyclock-digit{background:rgba(255,255,255,0.06);box-shadow:inset 0 1px 2px rgba(255,255,255,0.06)}}
.moneyclock-wheel{position:absolute;left:0;top:0;width:100%;will-change:transform;transition:transform var(--wheel-speed) ease-in-out}
.moneyclock-wheel span{display:flex;align-items:center;justify-content:center;height:var(--mc-digit-height);font-size:var(--mc-digit-fs)}
.moneyclock-decimal{width:auto;padding:0 calc(var(--mc-digit-fs)*0.14);font-size:var(--mc-digit-fs)}
.moneyclock-currency{width:auto;padding:0 calc(var(--mc-digit-fs)*0.21);font-size:var(--mc-digit-fs)}

.moneyclock-gear{position:fixed;top:12px;right:12px;opacity:.8}
.moneyclock-gear svg{width:clamp(20px,6vw,28px);height:clamp(20px,6vw,28px)}
.moneyclock-gear:hover{opacity:1;color:#0d6efd}

.modal .form-label{font-weight:600}
.modal .control-label{font-weight:600}
.modal-body .form-group{margin-bottom:12px}
.modal-body .form-control{max-width:none;margin:0 auto}
.modal-body .checkbox{margin:8px 0 12px}
.moneyclock-time-field{position:relative;display:block;width:240px;margin:0 auto}
.moneyclock-time-field .moneyclock-time-input{width:100%;box-sizing:border-box;color:inherit}
/* Native time picker icon color adapt */
.moneyclock-time-input::-webkit-calendar-picker-indicator{opacity:.85;filter:none}
@media (prefers-color-scheme: dark){
  .moneyclock-time-input::-webkit-calendar-picker-indicator{filter:invert(1) brightness(1.2)}
}

/* Modal theming for day/night */
.modal-content{background-color:#ffffff;color:var(--fg-day)}
.modal-header,.modal-footer{border-color:rgba(0,0,0,0.1)}
.form-control,.form-select{background-color:#ffffff;color:var(--fg-day)}

#moneyclock-settings-modal .modal-title{font-weight:800;font-size:22px}
@media (prefers-color-scheme: dark){
  .modal-content{background-color:#14161a;color:var(--fg-night);border-color:rgba(255,255,255,0.15)}
  .modal-header,.modal-footer{border-color:rgba(255,255,255,0.12)}
  .form-control,.form-select{background-color:#0f1115;color:var(--fg-night);border-color:rgba(255,255,255,0.18)}
  .form-control::placeholder{color:rgba(230,230,230,0.55)}
  .form-check-label{color:var(--fg-night)}
  .form-check-input{background-color:#0f1115;border-color:rgba(255,255,255,0.25)}
  .form-check-input:checked{background-color:#0d6efd;border-color:#0d6efd}
  .moneyclock-time-field .moneyclock-time-icon{opacity:.9}
}
    </style>
  </head>
  <body>
    <div id="moneyclock-app" class="moneyclock-app">
      <div class="moneyclock-container">
        <div class="moneyclock-gear" id="moneyclock-btn-settings" role="button" aria-label="设置" title="设置">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14,12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.37,7.37,0,0,0-1.63-.94l-.36-2.54A.5.5 0 0 0,13.9,1H10.1a.5.5 0 0 0-.5.42L9.24,3.96a7.37,7.37,0,0,0-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7,7.48a.5.5 0 0 0,.12.64L4.85,9.7c-.04.31-.06.63-.06.94s.02.63.06.94L2.82,13.16a.5.5 0 0 0-.12.64l1.92,3.32a.5.5 0 0 0,.6.22l2.39-.96c.5.4,1.04.72,1.63.94l.36,2.54a.5.5 0 0 0,.5.42h3.8a.5.5 0 0 0,.5-.42l.36-2.54c.59-.22,1.13-.54,1.63-.94l2.39.96a.5.5 0 0 0,.6-.22l1.92-3.32a.5.5 0 0 0-.12-.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
          </svg>
        </div>
        <div id="moneyclock-wage" class="moneyclock-wage" aria-live="polite" aria-label="今天已获得工资"></div>
      </div>
    </div>

    <!-- 设置 Modal -->
    <div class="modal fade" id="moneyclock-settings-modal" tabindex="-1" aria-labelledby="settingsLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="关闭"><span aria-hidden="true">&times;</span></button>
            <h5 class="modal-title" id="settingsLabel">设置</h5>
          </div>
          <div class="modal-body">
            <form id="settings-form">
              <div class="form-group">
                <label class="control-label">月薪（元）</label>
                <input type="number" step="0.01" min="0" class="form-control" id="moneyclock-salaryMonthly" />
              </div>
              <div class="form-group">
                <label class="control-label">每月上班天数</label>
                <input type="number" step="0.01" min="1" class="form-control" id="moneyclock-workDaysPerMonth" />
              </div>
              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label class="control-label">上班开始</label>
                    <div class="moneyclock-time-field">
                      <input type="time" class="form-control moneyclock-time-input" id="moneyclock-workStart" />
                    </div>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label class="control-label">上班结束</label>
                    <div class="moneyclock-time-field">
                      <input type="time" class="form-control moneyclock-time-input" id="moneyclock-workEnd" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label class="control-label">午休开始</label>
                    <div class="moneyclock-time-field">
                      <input type="time" class="form-control moneyclock-time-input" id="moneyclock-lunchStart" />
                    </div>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label class="control-label">午休结束</label>
                    <div class="moneyclock-time-field">
                      <input type="time" class="form-control moneyclock-time-input" id="moneyclock-lunchEnd" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="checkbox">
                <label>
                  <input type="checkbox" id="moneyclock-includeLunch" /> 上班时间包含午休
                </label>
              </div>
              <div class="form-group">
                <label class="control-label">刷新时间（秒）</label>
                <input type="number" step="1" min="1" class="form-control" id="moneyclock-refreshSec" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="save-settings">确认</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.2/dist/js/bootstrap.min.js"></script>
    <script>
(function($){
  const COOKIE_NAME = 'mc_settings';
  const COOKIE_DAYS = 365;

  const DEFAULTS = {
    salaryMonthly: 7000,
    workDaysPerMonth: 21.75,
    workStart: '08:00',
    workEnd: '17:30',
    lunchStart: '11:30',
    lunchEnd: '12:00',
    includeLunch: true,
    refreshSec: 1
  };

  // Storage adapter: prefer Cookie; fallback to localStorage (for file:// 等环境)
  const Storage = (()=>{
    let cookieTested = false;
    let cookieUsable = false;
    function canUseCookie(){
      if(cookieTested) return cookieUsable;
      cookieTested = true;
      try{
        const k = '__mc_test__';
        document.cookie = `${k}=1; max-age=5; path=/`;
        const ok = /(?:^|; )__mc_test__=1(?:;|$)/.test(document.cookie);
        // cleanup
        document.cookie = `${k}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
        cookieUsable = !!ok;
      }catch{ cookieUsable = false; }
      return cookieUsable;
    }
    return {
      get(){
        // try cookie
        if(canUseCookie()){
          const raw = readCookie(COOKIE_NAME);
          if(raw!=null) return decodeURIComponent(raw);
        }
        // fallback localStorage
        try{ return window.localStorage.getItem(COOKIE_NAME); }catch{ return null; }
      },
      set(str){
        let wrote = false;
        if(canUseCookie()){
          try{
            writeCookie(COOKIE_NAME, encodeURIComponent(str), COOKIE_DAYS);
            const back = readCookie(COOKIE_NAME);
            wrote = (back!=null);
          }catch{ wrote = false; }
        }
        if(!wrote){
          try{ window.localStorage.setItem(COOKIE_NAME, str); wrote = true; }catch{ /* ignore */ }
        }
        return wrote;
      }
    };
  })();

  let settings = null; // loaded later in init
  let ticker = null;
  let lastDisplay = null; // string with fixed 2 decimals
  let modal = null;

$(init);

const SEL = {
  wage: '#moneyclock-wage',
  btn: '#moneyclock-btn-settings',
  modal: '#moneyclock-settings-modal',
  salaryMonthly: '#moneyclock-salaryMonthly',
  workDaysPerMonth: '#moneyclock-workDaysPerMonth',
  workStart: '#moneyclock-workStart',
  workEnd: '#moneyclock-workEnd',
  lunchStart: '#moneyclock-lunchStart',
  lunchEnd: '#moneyclock-lunchEnd',
  includeLunch: '#moneyclock-includeLunch',
  refreshSec: '#moneyclock-refreshSec',
};

function init(){
    buildDisplay('0.00');
    // Init modal & UI (Bootstrap 3)
    modal = $(SEL.modal);
    bindUI();

    // Load settings flow
    const loaded = loadSettings();
    if(!loaded){
      // first open: write defaults to storage and show settings
      settings = {...DEFAULTS};
      saveSettings(settings);
      fillForm();
      startTicker();
      modal.modal('show');
    }else{
      settings = loaded;
      fillForm();
      startTicker();
    }
  }

  function bindUI(){
    $(SEL.btn).on('click', ()=>{
      fillForm();
      modal.modal('show');
    });

    // Disallow manual typing in time inputs, allow picker interactions
    $(document).on('keydown', '.moneyclock-time-input', function(e){
      // Allow Tab and navigation keys
      if($.inArray(e.which, [9,37,38,39,40]) !== -1) return;
      e.preventDefault();
    });
    $(document).on('paste drop', '.moneyclock-time-input', function(e){ e.preventDefault(); });

    // Immediate validation on time change
    $(SEL.workStart+','+SEL.workEnd+','+SEL.lunchStart+','+SEL.lunchEnd).on('change', function(){
      validateTimes(true);
    });

    // Save settings
    $('#save-settings').on('click', ()=>{
      const s = readForm();
      if(!s) return;
      settings = s;
      saveSettings(settings);
      startTicker();
      modal.modal('hide');
    });
  }

  function buildDisplay(text){
    const $wrap = $(SEL.wage);

    $wrap.empty();
    $wrap.append($('<div class=\"moneyclock-currency\">¥</div>'));
    const [intPart, fracPart] = text.split('.');
    const digits = (intPart).split('');
    digits.forEach((d)=> $wrap.append(makeDigit(parseInt(d,10)||0)));
    $wrap.append($('<div class=\"moneyclock-decimal\">.</div>'));
    const fds = (fracPart||'00').padEnd(2,'0').slice(0,2).split('');
    fds.forEach((d)=> $wrap.append(makeDigit(parseInt(d,10)||0)));
    lastDisplay = formatFixed(text);
    fitWage();
  }

  const REPEAT_CYCLES = 7; // more headroom to avoid visible backward normalization
  const CYCLE_SIZE = 10;
  const MIDDLE_BASE = Math.floor(REPEAT_CYCLES/2)*CYCLE_SIZE; // center block base index

  function makeDigit(initial){
    const $d = $('<div class="moneyclock-digit" role="img" aria-label="digit"></div>');
    const $wheel = $('<div class="moneyclock-wheel"></div>');
    for(let r=0;r<REPEAT_CYCLES;r++){
      for(let i=0;i<10;i++) $wheel.append($('<span></span>').text(i));
    }
    $d.append($wheel);
    setWheel($wheel, initial);
    return $d;
  }

  function setWheel($wheel, n){
    // Snap to the middle block at the required digit to avoid visible backward jumps
    const h = getDigitHeight();
    const idx = (n%10 + 10)%10; // 0..9
    const abs = MIDDLE_BASE + idx;
    $wheel.css('transition','none');
    $wheel.css('transform', `translateY(${-abs*h}px)`);
    // next frame re-enable transition for future animations
    requestAnimationFrame(()=>{
      $wheel.css('transition','transform var(--wheel-speed) ease-in-out');
    });
    $wheel.data('pos', abs);
  }

  function rollWheel($wheel, from, to){
    // Forward-only animation; choose start/normalize positions to avoid any backward visual
    if(!$wheel || !$wheel.length) return; // safety guard
    const h = getDigitHeight();
    const cur = (from%10+10)%10;
    const nxt = (to%10+10)%10;
    const steps = (nxt >= cur) ? (nxt - cur) : (10 - cur + nxt);

    const maxIndex = REPEAT_CYCLES*CYCLE_SIZE - 1;

    // Choose a normalization position (congruent to nxt) that is >= target
    let norm = MIDDLE_BASE + nxt;
    while(norm < 0) norm += CYCLE_SIZE;
    while(norm > maxIndex) norm -= CYCLE_SIZE;

    // Derive start so that start + steps = norm (no backward jump on normalize)
    let start = norm - steps;
    while(start < 0) { start += CYCLE_SIZE; norm += CYCLE_SIZE; }
    while(norm > maxIndex){ norm -= CYCLE_SIZE; start -= CYCLE_SIZE; }

    const target = start + steps;

    $wheel.off('transitionend');
    // Pre-snap to start without transition
    $wheel.css('transition','none');
    $wheel.css('transform', `translateY(${-start*h}px)`);
    $wheel.data('pos', start);
    // Force reflow so the next change animates
    if($wheel[0]) void $wheel[0].offsetHeight;

    // Animate to target
    $wheel.css('transition','transform var(--wheel-speed) ease-in-out');
    $wheel.css('transform', `translateY(${-target*h}px)`);

    // Normalize to norm (which is >= target) without visible backward move
    $wheel.one('transitionend', ()=>{
      $wheel.css('transition','none');
      $wheel.css('transform', `translateY(${-norm*h}px)`);
      requestAnimationFrame(()=>{
        $wheel.css('transition','transform var(--wheel-speed) ease-in-out');
      });
      $wheel.data('pos', norm);
    });
  }

  function updateDisplay(nextStr){
    nextStr = formatFixed(nextStr);
    if(lastDisplay === null){
      buildDisplay(nextStr);
      return;
    }
    if(nextStr.length !== lastDisplay.length){
      buildDisplay(nextStr);
      return;
    }
    const $wrap = $(SEL.wage);
    const children = $wrap.children().toArray();
    // children: [¥, d0, d1, ..., decimal, f0, f1]
    const prev = lastDisplay;
    const curr = nextStr;

    let acted = false;
    for(let i=curr.length-1;i>=0;i--){
      const c = curr[i];
      const p = prev[i];
      if(c === '.' || p === '.') continue;
      const childIndex = mapIndexToChild(i, curr.length);
      if(childIndex < 0 || childIndex >= children.length){
        buildDisplay(curr);
        lastDisplay = curr;
        return;
      }
      const $digit = $(children[childIndex]);
      const $wheel = $digit.find('.moneyclock-wheel');
      const from = parseInt(p,10);
      const to = parseInt(c,10);

      if(!$wheel.length){
        buildDisplay(curr);
        lastDisplay = curr;
        return;
      }

      if(p === c){
        // normalize unchanged digits to stable middle position (no animation)
        setWheel($wheel, to);
        continue;
      }

      // Always animate forward for any changed digit
      rollWheel($wheel, from, to);
      acted = true;
    }
    if(prev !== curr && !acted){
      // Fallback to rebuild to reflect the change in case animations were skipped
      buildDisplay(curr);
    }
    lastDisplay = curr;
    fitWage();
  }

  function isSuffixRollover(prev, curr, i){
    // Check if all lower-significance digits rolled from 9..9 to 0..0 (ignore decimal point)
    let prevDigits = '', currDigits = '';
    for(let k=i+1;k<prev.length;k++){
      if(prev[k]!=='.') prevDigits += prev[k];
    }
    for(let k=i+1;k<curr.length;k++){
      if(curr[k]!=='.') currDigits += curr[k];
    }
    if(prevDigits.length===0 || prevDigits.length!==currDigits.length) return false;
    return (/^9+$/.test(prevDigits) && /^0+$/.test(currDigits));
  }

  function mapIndexToChild(i, len){
    // Map index in string (including '.') to child index in #wage
    // string like "1234.56" => children [¥, d0,d1,d2,d3,.,f0,f1]
    // i=0 -> d0 => child 1
    const s = lastDisplay || '0.00';
    const decIdx = s.indexOf('.');
    let digitsBefore = 0;
    for(let k=0;k<i;k++){ if(s[k] !== '.') digitsBefore++; }
    let child = 1 + digitsBefore; // +1 for the currency symbol at [0]
    if(decIdx !== -1 && i > decIdx) child += 1; // account for the decimal separator element
    return child;
  }

  function getDigitHeight(){
    const $tmp = $('<div class=\"moneyclock-digit\"><div class=\"moneyclock-wheel\"><span>0</span></div></div>').appendTo('body');
    const h = Math.round($tmp.outerHeight());
    $tmp.remove();
    return h || 88;
  }

  function fitWage(){
    const $wrap = $(SEL.wage);
    if(!$wrap.length) return;
    $wrap.css('transform','none');
    const $container = $wrap.closest('.moneyclock-container');
    const containerW = ($container.length ? $container.innerWidth() : ($wrap.parent().innerWidth() || $(window).width()));
    const contentW = $wrap[0] ? $wrap[0].scrollWidth : containerW;
    if(!containerW || !contentW) return;
    var gap = 12;
    const scale = Math.min(1, (containerW - gap*2) / contentW);
    $wrap.css('transform', 'scale(' + scale + ')');
  }

  function startTicker(){
    if(ticker) clearInterval(ticker);
    if(!settings){ return; }
    renderOnce();
    const interval = Math.max(1, parseInt(settings.refreshSec,10)||1) * 1000;
    ticker = setInterval(renderOnce, interval);
    // Responsive scaling on resize/orientation changes
    var t;
    $(window).off('.mcfit').on('resize.mcfit orientationchange.mcfit', function(){
      clearTimeout(t); t = setTimeout(fitWage, 100);
    });
    fitWage();
  }

  function renderOnce(){
    const earned = computeEarnedToday();
    updateDisplay(earned.toFixed(2));
  }

  function computeEarnedToday(){
    const daySalary = Number(settings.salaryMonthly)/Number(settings.workDaysPerMonth);
    if(!isFinite(daySalary) || daySalary<=0) return 0;

    const now = new Date();
    const nowSec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds() + now.getMilliseconds()/1000;
    const ws = toSec(settings.workStart);
    const we = toSec(settings.workEnd);
    if(!(we>ws)) return 0; // invalid range

    let worked = clamp(nowSec, ws, we) - ws; // seconds worked within window
    let total = Math.max(0, we-ws);

    const ls = toSec(settings.lunchStart);
    const le = toSec(settings.lunchEnd);

    if(!settings.includeLunch){
      const lunchOverlapTotal = overlap([ws,we],[ls,le]);
      total -= Math.max(0, lunchOverlapTotal);
      const until = clamp(nowSec, ws, we);
      const lunchOverlapSoFar = overlap([ws, until],[ls,le]);
      worked -= Math.max(0, lunchOverlapSoFar);
    }

    worked = Math.min(Math.max(worked,0), Math.max(total,1));
    const ratio = total>0 ? (worked/total) : 0;
    const earned = daySalary * ratio;
    // clamp to [0, daySalary]
    return Math.min(daySalary, Math.max(0, earned));
  }

  function toSec(t){
    if(!t || !/^\d{2}:\d{2}$/.test(t)) return 0;
    const [h,m] = t.split(':').map(Number); return h*3600+m*60;
  }

  function overlap([a1,a2],[b1,b2]){
    const s = Math.max(a1,b1), e = Math.min(a2,b2); return Math.max(0,e-s);
  }

  function clamp(x, a, b){ return Math.min(Math.max(x, Math.min(a,b)), Math.max(a,b)); }

  function loadSettings(){
    const raw = Storage.get();
    if(!raw) return null;
    try{ const obj = JSON.parse(raw); return {...DEFAULTS, ...obj}; }
    catch{ return null; }
  }
  function saveSettings(s){ Storage.set(JSON.stringify(s)); }

  function readCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()\[\]\\\/\+^])/g,'\\$1')+'=([^;]*)'));
    return m? m[1] : null;
  }
  function writeCookie(name, value, days){
    const d = new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
    document.cookie = `${name}=${value}; expires=${d.toUTCString()}; path=/`;
  }

  function fillForm(){
    $(SEL.salaryMonthly).val(settings.salaryMonthly);
    $(SEL.workDaysPerMonth).val(settings.workDaysPerMonth);
    $(SEL.workStart).val(settings.workStart);
    $(SEL.workEnd).val(settings.workEnd);
    $(SEL.lunchStart).val(settings.lunchStart);
    $(SEL.lunchEnd).val(settings.lunchEnd);
    $(SEL.includeLunch).prop('checked', !!settings.includeLunch);
    $(SEL.refreshSec).val(settings.refreshSec);
  }
  function readForm(){
    const s = {
      salaryMonthly: parseFloat($(SEL.salaryMonthly).val()),
      workDaysPerMonth: parseFloat($(SEL.workDaysPerMonth).val()),
      workStart: String($(SEL.workStart).val()||'08:00'),
      workEnd: String($(SEL.workEnd).val()||'17:30'),
      lunchStart: String($(SEL.lunchStart).val()||'11:30'),
      lunchEnd: String($(SEL.lunchEnd).val()||'12:00'),
      includeLunch: !!$(SEL.includeLunch).is(':checked'),
      refreshSec: parseInt($(SEL.refreshSec).val(),10)||1,
    };
    if(!(s.salaryMonthly>0) || !(s.workDaysPerMonth>0)){
      alert('请填写有效的月薪与上班天数');
      return null;
    }
    if(!validateTimes(true)) return null;
    return s;
  }

  function setGroupError($input, isError){
    var $grp = $input.closest('.form-group');
    $grp.toggleClass('has-error', !!isError);
    if(isError){ $input.attr('aria-invalid','true'); } else { $input.removeAttr('aria-invalid'); }
  }

  function validateTimes(showAlert){
    var $ws = $(SEL.workStart), $we = $(SEL.workEnd), $ls = $(SEL.lunchStart), $le = $(SEL.lunchEnd);
    var s = {
      workStart: String($ws.val()||'08:00'),
      workEnd: String($we.val()||'17:30'),
      lunchStart: String($ls.val()||'11:30'),
      lunchEnd: String($le.val()||'12:00'),
    };
    var ws = toSec(s.workStart), we = toSec(s.workEnd);
    var ls = toSec(s.lunchStart), le = toSec(s.lunchEnd);

    // reset
    setGroupError($ws, false); setGroupError($we, false);
    setGroupError($ls, false); setGroupError($le, false);

    if(!(we>ws)){
      setGroupError($ws, true); setGroupError($we, true);
      if(showAlert) alert('上班时间无效：结束时间必须晚于开始时间');
      return false;
    }
    if(!(le>ls)){
      setGroupError($ls, true); setGroupError($le, true);
      if(showAlert) alert('午休时间无效：结束时间必须晚于开始时间');
      return false;
    }
    if(ls < ws || le > we){
      setGroupError($ls, true); setGroupError($le, true);
      if(showAlert) alert('午休时间超出上班时间范围，请调整');
      return false;
    }
    return true;
  }

  function formatFixed(v){
    const n = (typeof v==='number')? v : parseFloat(v);
    if(!isFinite(n)) return '0.00';
    const s = n.toFixed(2);
    // Ensure at least one integer digit
    return s.replace(/^\./,'0.');
  }

})(jQuery);
    </script>
  </body>
</html>

